<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0"
  >
  <title>Spotlight</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Main CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

  <div id="app-shell">
    <!-- HEADER -->
    <header class="app-topbar">
      <div class="topbar-leading">
        <div class="user-avatar" onclick="goToSettings()" title="{{ user.username }}">
          <img src="{{ user.avatar_url }}" alt="{{ user.username }}">
        </div>

        <div class="trust-score-pill">
          <i class="fas fa-shield-halved"></i>
          <span id="my-trust-score">--</span>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="topbar-actions">
        <button class="text-btn" onclick="fetchMyFeedback()" aria-label="Open my feedback">
          <i class="fas fa-comment-dots"></i>
          <span>My Feedback</span>
        </button>
        <button class="text-btn" onclick="reportApp()" aria-label="Report app issue">
          <i class="fas fa-flag"></i>
          <span>Report App</span>
        </button>
      </div>

      <div class="bell-wrapper">
        <div class="bell-icon" id="bellIcon" onclick="toggleBellBox()">
          <i class="fas fa-bell"></i>
          <span id="bell-dot" class="bell-dot hidden"></span>
        </div>
        <div class="bell-box hidden" id="bellBox"></div>
      </div>
    </header>

    <!-- =========================
         MAP
    ========================== -->
    <div id="map"></div>

    <!-- Nearby carousel -->
    <div id="nearby-carousel" class="nearby-carousel"></div>

    <!-- =========================
         LIVE STATUS PILL
    ========================== -->
    <div id="live-indicator" class="live-status hidden">
      <div class="pulsing-dot"></div>
      <span>You are Live</span>
      <button onclick="turnOffSpotlight()" class="text-btn">OFF</button>
    </div>

    <!-- =========================
         FLOATING ACTION BUTTON
    ========================== -->
    <div class="fab-container" id="main-fab">
      <button class="glow-btn" onclick="openSheet('checkin-sheet')">
        <i class="fas fa-location-dot"></i>
        Check In
      </button>
    </div>

    <!-- =========================
         OVERLAY
    ========================== -->
    <div id="overlay" class="overlay hidden" onclick="closeAllSheets()"></div>

    <!-- =========================
         CHECK‑IN SHEET
    ========================== -->
    <div id="checkin-sheet" class="bottom-sheet">
      <div class="sheet-handle"></div>

      <div class="sheet-body">
        <h2>Go Spotlight</h2>
        <p class="subtitle">Visible to active users</p>

        <div class="input-group">
          <input id="place" placeholder="Where are you? (Starbucks, Library)">
        </div>

        <div class="input-group">
          <input id="intent" placeholder="Why are you here? (Coffee, Study)">
        </div>

        <div class="input-group">
          <input id="meet_time" type="datetime-local">
        </div>

        <div class="input-group">
          <select id="bill">
            <option value="split">Split Bill</option>
            <option value="self">Pay Individually</option>
            <option value="host">I Will Pay</option>
          </select>
        </div>

        <div class="input-group">
          <input id="visual-clue" placeholder="Visual clue (e.g. red jacket)">
        </div>

        <div class="action-row">
          <button class="secondary-btn" onclick="closeAllSheets()">Cancel</button>
          <button class="primary-btn" onclick="confirmCheckIn()">Go Live</button>
        </div>
      </div>
    </div>

    <!-- =========================
         PROFILE SHEET
    ========================== -->
    <div id="profile-sheet" class="bottom-sheet">
      <div class="sheet-handle"></div>

      <div class="profile-header">
        <div class="avatar-ring" id="p-avatar">
          <i class="fas fa-user"></i>
        </div>

        <div class="profile-meta">
          <h2 id="p-username">Username</h2>
          <div class="trust-badge">
            <i class="fas fa-star"></i>
            <span id="p-score">--</span> Trust
          </div>
        </div>
      </div>

      <div class="sheet-body">
        <div class="profile-field">
          <p class="profile-field-label">Place / Location</p>
          <p class="profile-field-value" id="p-place"></p>
        </div>

        <div class="profile-field">
          <p class="profile-field-label">Purpose</p>
          <p class="profile-field-value" id="p-intent"></p>
        </div>

        <div class="profile-field">
          <p class="profile-field-label">Meeting Time / Arrival</p>
          <p class="profile-field-value" id="p-time"></p>
        </div>

        <div id="p-clue-wrap" class="hidden profile-field">
          <p class="profile-field-label">How To Recognize Me</p>
          <div class="visual-clue" id="p-clue"></div>
        </div>

        <div id="p-bio-wrap" class="hidden profile-field">
          <p class="profile-field-label">About Me / Bio</p>
          <div class="profile-bio" id="p-bio"></div>
        </div>

        <div class="profile-field hidden" id="p-vibes-group">
          <p class="profile-field-label">Hobbies</p>
          <div id="p-vibes-wrap" class="profile-vibes"></div>
        </div>

        <div class="profile-field hidden" id="p-feedback-group">
          <details id="p-feedback-dropdown" class="profile-feedback-dropdown">
            <summary id="p-feedback-summary" class="profile-field-label">Past Feedback</summary>
            <div id="p-feedback-wrap" class="profile-feedback-list"></div>
          </details>
        </div>

        <div class="action-row">
          <button class="secondary-btn" onclick="closeAllSheets()">Cancel</button>
          <button class="primary-btn" onclick="sendRequest()">
            <i class="fas fa-paper-plane"></i>
            Request to Join
          </button>
          <button class="secondary-btn" onclick="reportUser()">Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- =========================
       MATCH VIEW (hidden)
  ========================== -->
  <div id="match-view" class="match-overlay hidden">
    <div class="match-card">
      <button class="match-help-btn" onclick="toggleMatchHelp()" title="How this works">i</button>
      <div id="match-help-box" class="match-help-box hidden">
        <strong>What to do</strong>
        <p>1. Press <b>I Reached</b> when you arrive.</p>
        <p>2. If plans change before reaching, use <b>Emergency End Match</b>.</p>
        <p>3. After reaching, use <b>End Match</b> when done.</p>
      </div>
      <h2>Match Timeline</h2>
      <p class="muted">Stay aligned and keep updates clear.</p>

      <div class="timeline-track">
        <div class="timeline-step is-active" id="tl-matched">
          <div class="timeline-dot"></div>
          <span>Matched</span>
        </div>
        <div class="timeline-step" id="tl-way">
          <div class="timeline-dot"></div>
          <span>On the way</span>
        </div>
        <div class="timeline-step" id="tl-reached">
          <div class="timeline-dot"></div>
          <span>Reached</span>
        </div>
        <div class="timeline-step" id="tl-ended">
          <div class="timeline-dot"></div>
          <span>Ended</span>
        </div>
      </div>

      <div class="reached-pill-row">
        <div id="reach-pill-you" class="reached-pill">You: On the way</div>
        <div id="reach-pill-match" class="reached-pill">Match: On the way</div>
      </div>

      <p id="reached-status" class="muted timeline-status"></p>
      <div class="match-actions">
        <button id="reached-btn" class="secondary-btn" onclick="markReached()">I Reached</button>
        <button id="end-match-btn" class="primary-btn" onclick="handleMatchEndAction()">Emergency End Match</button>
      </div>
    </div>
  </div>

  <div id="end-match-modal" class="end-match-modal hidden">
    <div class="end-match-card">
      <h3>End Match</h3>
      <p class="muted">If you have not reached yet, select a reason (or write one).</p>
      <div id="end-reason-chips" class="reason-chip-wrap">
        <button type="button" class="reason-chip" data-reason="Running late and cannot make it.">Running late</button>
        <button type="button" class="reason-chip" data-reason="Emergency came up. Sorry for the inconvenience.">Emergency</button>
        <button type="button" class="reason-chip" data-reason="Location mismatch and unable to find each other.">Location mismatch</button>
        <button type="button" class="reason-chip" data-reason="Need to reschedule for another time.">Need to reschedule</button>
      </div>
      <textarea id="end-reason-text" placeholder="Optional details (max 50 words)"></textarea>
      <div id="end-reason-counter" class="muted">0 / 50 words</div>
      <div id="end-reason-error" class="reason-error hidden"></div>
      <div class="action-row">
        <button class="secondary-btn" onclick="closeEndMatchModal()">Cancel</button>
        <button class="primary-btn" onclick="confirmEndMatch()">Confirm End</button>
      </div>
    </div>
  </div>

  <!-- =========================
       POST MATCH VIEW (hidden)
  ========================== -->
  <div id="post-match-view" class="hidden post-match-view">
    <div class="post-match-card">
      <h2 id="post-match-title">Match Completed</h2>
      <p id="post-match-subtitle" class="muted"></p>
      <div id="post-match-badge" class="post-match-badge">After meetup</div>
      <div id="post-match-reason" class="end-by-other-note hidden"></div>
      <div class="action-row">
        <button id="post-match-cta" onclick="proceedToFeedback()" class="primary-btn">Continue to Rating</button>
      </div>
    </div>
  </div>

  <!-- =========================
       FEEDBACK VIEW (hidden)
   ========================== -->
  <div id="feedback-view" class="hidden feedback-view">
    <div class="feedback-card">
      <h2>⭐ Rate Your Match ⭐</h2>
      <p id="feedback-username"></p>
      <div id="rating-box"></div>
      <textarea id="feedback-text" placeholder="Write up to 50 words"></textarea>
      <div class="action-row">
        <button onclick="submitFeedback()" class="primary-btn">Submit</button>
      </div>
    </div>
  </div>

  <!-- =========================
       SCRIPTS
  ========================== -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="{{ url_for('static', filename='script.js') }}"></script>

</body>
</html>
